# 视频直播服务：
由于nodejs的事件驱动，高并发，异步编程，专为网络设计的特性，所以服务器整体基于nodejs进行搭建。该系统提供了提供便捷接入、高清流畅、低延迟、高并发，多种交互的教学音视频直播服务。

## 服务简介：
1. 视频播放
    支持web，android，ios视频，在线直播的全平台播放，同时优化了首屏体验，实现了首屏秒开

2. 直播转码
    实现了窄带宽高清转码，相同清晰度下为用户节省带宽，码率自适应的技术可以方便用户在不同网络状况下都获得良好的用户体验

3. 安全防护
    实现url加密鉴权，放盗链，https安全加速，防劫持防篡改

4. 师生互动
    通过websocket服务器实现了教师端向学生端发起测验，实时收集测验结果反馈给老师，学生可以在老师的控制下进行主题讨论，并把讨论结果反馈给老师，老师及时地查看学生讨论结果

5. 录像播放
    直播开启的同时可以录制视频，错过直播的用户可以方便的观看视频

## 1. HttpServer
我们基于egg开发该服务器，主要提供权限认证，RESTful接口等web服务;
我们用passport去进行用户鉴权，基于OAuth协议，同时可以收到客户端发起的http请求并通过websocket服务器向相应房间进行广播
### 1.1 Egg
Egg.js 为企业级框架和应用而生，我们希望由 Egg.js 孕育出更多上层框架，帮助开发团队和开发人员降低开发和维护成本。

### 1.2 设计原则
我们深知企业级应用在追求规范和共建的同时，还需要考虑如何平衡不同团队之间的差异，求同存异。所以我们没有选择社区常见框架的大集市模式（集成如数据库、模板引擎、前端框架等功能），而是专注于提供 Web 开发的核心功能和一套灵活可扩展的插件机制。我们不会做出技术选型，因为固定的技术选型会使框架的扩展性变差，无法满足各种定制需求。通过 Egg，团队的架构师和技术负责人可以非常容易地基于自身的技术架构在 Egg 基础上扩展出适合自身业务场景的框架。

Egg 的插件机制有很高的可扩展性，一个插件只做一件事（比如 Nunjucks 模板封装成了 egg-view-nunjucks、MySQL 数据库封装成了 egg-mysql）。Egg 通过框架聚合这些插件，并根据自己的业务场景定制配置，这样应用的开发成本就变得很低。

Egg 奉行『约定优于配置』，按照一套统一的约定进行应用开发，团队内部采用这种方式可以减少开发人员的学习成本，开发人员不再是『钉子』，可以流动起来。没有约定的团队，沟通成本是非常高的，比如有人会按目录分栈而其他人按目录分功能，开发者认知不一致很容易犯错。但约定不等于扩展性差，相反 Egg 有很高的扩展性，可以按照团队的约定定制框架。使用 Loader 可以让框架根据不同环境定义默认配置，还可以覆盖 Egg 的默认约定。

### 1.3 与其他框架差异

Express 是 Node.js 社区广泛使用的框架，简单且扩展性强，非常适合做个人项目。但框架本身缺少约定，标准的 MVC 模型会有各种千奇百怪的写法。Egg 按照约定进行开发，奉行『约定优于配置』，团队协作成本低。

Sails 是和 Egg 一样奉行『约定优于配置』的框架，扩展性也非常好。但是相比 Egg，Sails 支持 Blueprint REST API、WaterLine 这样可扩展的 ORM、前端集成、WebSocket 等，但这些功能都是由 Sails 提供的。而 Egg 不直接提供功能，只是集成各种功能插件，比如实现 egg-blueprint，egg-waterline 等这样的插件，再使用 sails-egg 框架整合这些插件就可以替代 Sails 了。


### 1.4 综述

为了后续的可扩展性和稳定性考虑,我们选择了阿里提出的egg框架,方便于以后业务框架的沉淀以及积累

## 2. MediaServer
我们基于node-media-server开发此流媒体服务器，提供直播播放，录播回放等功能，具有以下特性：
* 支持的音视频编码 H.264/H.265/AAC/SPEEX/NELLYMOSER
* 支持缓存最近一个关键帧间隔数据，实现RTMP协议秒开
* 支持RTMP直播流转LIVE-HTTP-FLV流,支持 flv.js 播放
* 支持RTMP直播流转LIVE-WebSocket-FLV,支持 flv.js 播放
* 支持星域CDN风格的鉴权
* 支持事件回调
* 支持https/wss加密传输
* 支持服务器和流媒体信息统计
* 支持RTMP直播流转HLS,DASH直播流
* 支持RTMP直播流录制为MP4文件并开启faststart
* 支持RTMP/RTSP中继

### 2.1 视频传输协议

* RTP
RTP（Real-time Transport Protocol）即实时传输协议，是用于Internet上针对多媒体数据流的一种传输协议。RTP被定义为在一对一或一对多的传输情况下工作，其目的是提供时间信息和实现流同步。RTP通常使用UDP来传送数据，但RTP也可以在TCP或ATM 等其它协议之上工作。当应用程序开始一个RTP会话时将使用两个端口：一个给RTP，一个给RTCP。RTP本身并不能为按顺序传送数据包提供可靠的传送机制，也不提供流量控制或拥塞控制，它依靠RTCP提供这些服务。通常RTP算法并不作为一个独立的网络层来实现，而是作为应用程序代码的一部分。

* RTCP

RTCP（Real-time	Transport Control Protocol）即实时传输控制协议，它和RTP一起提供流量控制和拥塞控制服务。在RTP会话期间，各参与者周期性的传送RTCP包。RTCP包中含有已发送的数据包的数量、丢失的数据包的数量等统计资料，因此，服务器可以利用这些信息动态的改变传送速率，甚至改变有效载荷类型。RTP和RTCP配合使用，它们能以有效的反馈和最小的开销使传输效率最佳化，因而特别适合传送网上的实时数据。

* RTSP

RTSP（Real Time Streaming Protocol）即实时流协议，是由 Real	Networks和Netscape共同提出的，该协议定义了一对多应用程序如何有效地通过IP网络传送多媒体数据。RTSP在体系结构上位于RTP和RTCP之上，它使用TCP或RTP完成数据传输。

* RSVP
资源预定协议RSVP（Resource Reserve Protocol）是正在开发的Internet上的资源预定协议。由于音频和视频数据流比传统数据对网络的延时更敏感，要在网络中传输高质量的音频、视频信息，除带宽要求之外，还需要其它更多的条件。使用RSVP预留一部分网络资源（即带宽），能在一定程度上为流媒体的传输提供方便。

* RMTP RTMP是Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议基于TCP，是一个协议族，包括RTMP基本协议及RTMPT/RTMPS/RTMPE等多种变种。RTMP是一种设计用来进行实时数据通信的网络协议，主要用来在Flash/AIR平台和支持RTMP协议的流媒体/交互服务器之间进行音视频和数据通信。支持该协议的软件包括Adobe Media Server/Ultrant Media Server/red5等。

- 综上所述,我们选择了实现最方便也是最容易实现的的RTMP协议,这样可以方便的用ffmpeg或者obs进行推流,降低了教师端开发的难度,同时通过ffmpeg进行视频的转码处理实现了多种格式的播放,系统的兼容性得到了保障




## 3. SocketServer
我们基于egg-socket.io开发websocket服务器，提供了房间管理，在线课题测验，在线课堂讨论等功能，具有以下特性：
* 使用wss加密保证用户数据
* 支持namespace和room双层空间，方便对直播进行房间管理，对用户进行分组管理
* 与http服务器深度绑定，可以通特定api去进行关闭直播，发起事件等功能

### 3.1 实时通讯协议

* WebSocket
WebSocket 协议在2008年诞生，2011年成为国际标准。目前所有主流浏览器都已经支持了,其有以下特点:

1. 服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于服务器推送技术的一种。
2. 建立在 TCP 协议之上，服务器端的实现比较容易。
3. 与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。
4. 数据格式比较轻量，性能开销小，通信高效。
5. 可以发送文本，也可以发送二进制数据。
6. 没有同源限制，客户端可以与任意服务器通信。
7. 协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。


* WebRTC
WebRTC，名称源自网页实时通信（Web Real-Time Communication）的缩写，是一个支持网页浏览器进行实时语音对话或视频对话的技术，是谷歌2010年以6820万美元收购Global IP Solutions公司而获得的一项技术。2011年5月开放了工程的源代码，在行业内得到了广泛的支持和应用，成为下一代视频通话的标准,广泛应用于p2p视频会议

首先我们定位于教师面向学生的授课,系统应为星型,因此我们选择用websocket,而不是webRTC实现,采用在实现websocket最为稳定且应用广泛的socketio上封装后的egg-socket.io框架,开发此服务器,保证系统低延迟,高并发的特性同时又便于开发,方便日后更新迭代

